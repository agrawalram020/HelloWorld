pipeline 
{
    agent any

    stages 
	{
        stage('Hello') 
		{
            steps 
			{
				script 
				{
					try 
					{
						dir("dev/${workbench_name}")
						{
							bat 'echo %tfvars%>>test.tfvars'
							bat 'echo service_id %workbench_name%'
							bat 'echo workbench id %workbench_id%'
							echo "${currentBuild.number}"
							bat 'echo line3_in_vm_name'
							bat 'echo %workbench_name%'
							bat 'python demo.py test.tfvars'
							httpRequest "http://127.0.0.1:8000/demourlcheck/${workbench_id}/${workbench_name}/${currentBuild.number}"
						}
					}
					catch(Exception e)
					{
						bat 'echo error in Hello step'
					}
					finally 
					{
						bat 'echo final of hello step'
					}
				}
			}
		}
      
      stage('Terraform Init') 
	    { 
			steps 
			{
				script 
				{
					try 
					{
						dir("dev/${workbench_name}")
						{
							bat 'terraform init'
						}
					}
					catch(Exception e)
					{
						bat 'echo error in terraform init'
					}
					finally 
					{
						bat 'echo final of tera init step'
					}
				}
			}
		}
		
		
		stage('Terraform Plan') 
		{ 
			steps 
			{
                script 
				{
					try 
					{
						dir("dev/${workbench_name}")
						{
							bat 'echo terraformplan'
						}
					}
					catch(Exception e)
					{
						bat 'echo error in terraform plan'
					}
					finally 
					{
						bat 'echo final of plan step'
					}
				}
					
			}
		}
		
		stage('Terraform Apply') 
		{ 
            steps 
			{
                script 
				{
					try 
					{
						bat 'echo "Apply"'
						dir("dev/${workbench_name}")
						{
							bat 'echo terraformapply'
						}
					}
					catch(Exception e)
					{
						bat 'echo error in terraform apply'
					}
					finally 
					{
						bat 'echo final of apply step'
					}
				}
			}
		}
	
	}
	
	post 
	{
		always 
		{
			bat 'echo deleting files'
			dir("dev/${workbench_name}")
			{
				bat 'del test.tfvars'
			}
			emailext body: "The resource ${workbench_id} successfully created", recipientProviders: [[$class: 'DevelopersRecipientProvider'], [$class: 'RequesterRecipientProvider']], subject: "${workbench_name}"
		}
	}
}
